# /etc/ipsec.conf - strongSwan IPsec configuration file (Client - IKEv2 Certificate Auth)

config setup
    # Enable detailed logging for debugging
    charondebug="ike 2, knl 2, cfg 2, net 2, esp 2, dmn 2, mgr 2"

conn ikev2-cert-to-server # Changed connection name for clarity
    auto=start
    keyexchange=ikev2
    # --- Client Settings (Left) ---
    left=%defaultroute
    leftsourceip=%config
    # ✅ Client uses its private key and certificate for authentication
    leftauth=pubkey
    # ✅ Specify the path to the PKCS12 file mounted from the server's data volume
    leftcert=/etc/ipsec_server/vpnclient.p12 # Corrected path based on previous discussion
    # ✅ Client ID should ideally match the Subject DN in the certificate
    leftid="CN=vpnclient"

    # --- Server Settings (Right) ---
    right=ipsec-server          # Service name
    rightid=@ipsec-server       # Server's ID (must match server config)
    rightsubnet=0.0.0.0/0       # Full Tunnel
    # ✅ Server still authenticates using PSK
    rightauth=psk

    # --- Use Cipher Suites specified earlier (or comment out to auto-negotiate) ---
    ike=aes256gcm16-sha256-ecp256,aes256-sha256-modp2048,aes128-sha256-modp2048,aes256-sha1-modp1024,aes128-sha1-modp1024!
    esp=aes256gcm16,aes128-sha1,aes256-sha1,aes128-sha256,aes256-sha256!
    # --- ❌ ลบบรรทัดนี้ออก ---
    # authby=rsa-sha1

# exec ipsec start --nofork 
# exec ipsec start --nofork &

# ipsec up ikev2-to-server
# ipsec up ikev2-to-server
# docker exec -it ipsec-client /bin/sh
# docker exec -it ipsec-client /bin/sh ipsec up ikev2-to-server
